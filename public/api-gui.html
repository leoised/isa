<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800" x-data="app()">

    <nav class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Uni-Manager</h1>
            <div class="space-x-4">
                <button @click="tab='students'; fetchStudents()" :class="tab==='students'?'underline':''">Students</button>
                <button @click="tab='courses'; fetchCourses()" :class="tab==='courses'?'underline':''">Courses</button>
                <button @click="tab='enrollment'; fetchAllStudents()" :class="tab==='enrollment'?'underline':''">Records</button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto p-6">
        <!-- Error Box -->
        <div x-show="errorMsg" class="bg-red-100 text-red-700 p-3 rounded mb-4 border border-red-300 flex justify-between">
            <span x-text="errorMsg"></span>
            <button @click="errorMsg=''" class="font-bold">&times;</button>
        </div>

        <!-- STUDENTS TAB -->
        <div x-show="tab==='students'">
            <div class="bg-white p-4 rounded shadow mb-6 flex gap-4">
                <input x-model.debounce="searchQuery" @input="fetchStudents(1)" type="text" placeholder="Search..." class="border p-2 rounded w-full">
                <select x-model="studentSort.by" @change="fetchStudents(1)" class="border p-2 rounded">
                    <option value="id">ID</option>
                    <option value="name">Name</option>
                    <option value="age">Age</option>
                </select>
                <button @click="showModal='student'" class="bg-blue-600 text-white px-4 py-2 rounded">Add New</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="s in students" :key="s.id">
                    <div class="bg-white p-4 rounded shadow relative">
                        <button @click="deleteStudent(s.id)" class="absolute top-2 right-2 text-red-400 hover:text-red-600">&times;</button>
                        <h3 class="font-bold text-lg" x-text="s.name"></h3>
                        <p class="text-sm text-gray-500" x-text="s.email"></p>
                        <p class="text-xs mt-2 font-bold text-gray-400">COURSES:</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <template x-for="c in s.courses" :key="c.id">
                                <span class="text-xs bg-blue-100 text-blue-800 px-1 rounded cursor-pointer" @click="goToRecord(s.id, c.id)" x-text="c.title"></span>
                            </template>
                            <span x-show="!s.courses.length" class="text-xs text-gray-300">None</span>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Pagination -->
            <div class="mt-4 flex justify-center gap-2">
                <button @click="fetchStudents(pagination.current_page - 1)" :disabled="pagination.current_page <= 1" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">Prev</button>
                <button @click="fetchStudents(pagination.current_page + 1)" :disabled="pagination.current_page >= pagination.last_page" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">Next</button>
            </div>
        </div>

        <!-- COURSES TAB -->
        <div x-show="tab==='courses'">
            <div class="bg-white p-4 rounded shadow mb-6 flex gap-2">
                <input x-model="newCourse.title" placeholder="Course Title" class="border p-2 rounded flex-1">
                <input x-model.number="newCourse.credits" type="number" placeholder="Credits" class="border p-2 rounded w-24">
                <button @click="createCourse" class="bg-green-600 text-white px-4 rounded">Create</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <template x-for="c in courses" :key="c.id">
                    <div class="bg-white p-4 rounded shadow flex justify-between items-center">
                        <div>
                            <h3 class="font-bold" x-text="c.title"></h3>
                            <span class="text-xs bg-gray-200 px-2 rounded" x-text="c.credits + ' Cr'"></span>
                        </div>
                        <button @click="deleteCourse(c.id)" class="text-red-500 hover:text-red-700">Delete</button>
                    </div>
                </template>
            </div>
        </div>

        <!-- RECORDS TAB -->
        <div x-show="tab==='enrollment'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded shadow">
                <h3 class="font-bold border-b mb-4 pb-2">1. Select Student & Course</h3>
                <label class="block text-sm mb-1">Student</label>
                <select x-model="selectedStudentId" @change="loadStudentEnrollments" class="w-full border p-2 rounded mb-4">
                    <option value="">Choose...</option>
                    <template x-for="s in allStudents" :key="s.id"><option :value="s.id" x-text="s.name"></option></template>
                </select>

                <div x-show="selectedStudentId">
                    <label class="block text-sm mb-1">Manage Course</label>
                    <div class="space-y-2 mb-4">
                        <template x-for="c in availableCourses" :key="c.id">
                            <div @click="selectCourseForRecord(c.id)" :class="selectedCourseId==c.id ? 'bg-blue-50 border-blue-500' : 'bg-gray-50'" class="border p-2 rounded cursor-pointer hover:bg-gray-100">
                                <span x-text="c.title"></span>
                            </div>
                        </template>
                    </div>
                    
                    <div class="border-t pt-2">
                        <label class="text-xs text-gray-500">Enroll in new:</label>
                        <div class="flex gap-2">
                            <select x-model="courseToEnrollId" class="border p-1 rounded w-full text-sm">
                                <option value="">Select...</option>
                                <template x-for="c in courses" :key="c.id"><option :value="c.id" x-text="c.title"></option></template>
                            </select>
                            <button @click="enroll" class="bg-blue-600 text-white px-3 rounded text-sm">Add</button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="selectedCourseId" class="bg-white p-6 rounded shadow">
                <h3 class="font-bold border-b mb-4 pb-2">2. Grading & Attendance</h3>
                
                <label class="block text-sm mb-1">Grade (0-100)</label>
                <input x-model.number="currentRecord.grade" type="number" class="border p-2 rounded w-full mb-4">

                <label class="block text-sm mb-1">Attendance</label>
                <div class="flex gap-2 mb-2">
                    <button @click="currentRecord.attendance_record += 'A'" class="flex-1 bg-green-100 text-green-800 py-1 rounded">+ Present (A)</button>
                    <button @click="currentRecord.attendance_record += 'X'" class="flex-1 bg-red-100 text-red-800 py-1 rounded">+ Absent (X)</button>
                </div>
                <div class="bg-gray-800 text-white p-2 rounded font-mono text-center mb-1" x-text="currentRecord.attendance_record || '-'"></div>
                <button @click="currentRecord.attendance_record=''" class="text-xs text-red-500 underline block mb-4 text-right">Clear</button>

                <button @click="saveRecord" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ADD STUDENT MODAL -->
    <div x-show="showModal==='student'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow w-96">
            <h3 class="font-bold text-xl mb-4">Add Student</h3>
            <input x-model="newStudent.name" placeholder="Name" class="w-full border p-2 rounded mb-2">
            <input x-model="newStudent.email" placeholder="Email" class="w-full border p-2 rounded mb-2">
            <input x-model.number="newStudent.age" type="number" placeholder="Age" class="w-full border p-2 rounded mb-4">
            <div class="flex justify-end gap-2">
                <button @click="showModal=null" class="text-gray-500">Cancel</button>
                <button @click="createStudent" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                tab: 'students',
                showModal: null,
                errorMsg: '',
                baseUrl: 'http://127.0.0.1:8000/api',
                
                students: [],
                courses: [],
                allStudents: [],
                availableCourses: [],
                pagination: {},
                
                searchQuery: '',
                studentSort: { by: 'id', order: 'desc' },
                
                newStudent: { name: '', email: '', age: '' },
                newCourse: { title: '', credits: '' },
                
                selectedStudentId: '',
                selectedCourseId: '',
                courseToEnrollId: '',
                currentRecord: { grade: 0, attendance_record: '' },

                init() {
                    this.fetchStudents();
                    this.fetchCourses();
                    this.fetchAllStudents();
                },

                async req(url, method = 'GET', body = null) {
                    try {
                        const opts = { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' } };
                        if (body) opts.body = JSON.stringify(body);
                        const res = await fetch(url, opts);
                        if (!res.ok) {
                            const err = await res.json().catch(()=>({}));
                            throw new Error(err.message || 'Request failed');
                        }
                        return res.status === 204 ? true : await res.json();
                    } catch (e) {
                        this.errorMsg = e.message;
                        console.error(e);
                        return null;
                    }
                },

                async fetchStudents(page = 1) {
                    const data = await this.req(`${this.baseUrl}/students?page=${page}&search=${this.searchQuery}&sort_by=${this.studentSort.by}`);
                    if (data) { this.students = data.data; this.pagination = data; }
                },
                async fetchCourses() {
                    const data = await this.req(`${this.baseUrl}/courses`);
                    if (data) this.courses = data.data;
                },
                async fetchAllStudents() {
                    const data = await this.req(`${this.baseUrl}/students?per_page=100`);
                    if (data) this.allStudents = data.data;
                },

                async createStudent() {
                    if (await this.req(`${this.baseUrl}/students`, 'POST', this.newStudent)) {
                        this.showModal = null; this.newStudent = {name:'',email:'',age:''}; this.fetchStudents();
                    }
                },
                async deleteStudent(id) {
                    if(confirm('Delete?')) { await this.req(`${this.baseUrl}/students/${id}`, 'DELETE'); this.fetchStudents(); }
                },
                async createCourse() {
                    if (await this.req(`${this.baseUrl}/courses`, 'POST', this.newCourse)) {
                        this.newCourse = {title:'', credits:''}; this.fetchCourses();
                    }
                },
                async deleteCourse(id) {
                    if(confirm('Delete?')) { await this.req(`${this.baseUrl}/courses/${id}`, 'DELETE'); this.fetchCourses(); }
                },

                async loadStudentEnrollments() {
                    if(!this.selectedStudentId) return;
                    this.availableCourses = await this.req(`${this.baseUrl}/enrollments/student/${this.selectedStudentId}`);
                    this.selectedCourseId = null;
                },
                async enroll() {
                    if (await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${this.courseToEnrollId}`, 'POST')) {
                        this.loadStudentEnrollments();
                    }
                },
                async selectCourseForRecord(cid) {
                    this.selectedCourseId = cid;
                    const data = await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${cid}`);
                    if (data) this.currentRecord = { grade: data.grade||0, attendance_record: data.attendance_record||'' };
                },
                async saveRecord() {
                    if (await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${this.selectedCourseId}`, 'PUT', this.currentRecord)) {
                        alert('Saved!');
                    }
                },
                goToRecord(sid, cid) {
                    this.tab = 'enrollment';
                    this.selectedStudentId = sid;
                    this.loadStudentEnrollments().then(() => this.selectCourseForRecord(cid));
                }
            }))
        })
    </script>
</body>
</html>