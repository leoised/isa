<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style> [x-cloak] { display: none !important; } </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="app()">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-indigo-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">Academic Portal</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="tab = 'students'" :class="tab === 'students' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-2 text-sm font-medium transition-colors">Students</button>
                    <button @click="tab = 'courses'" :class="tab === 'courses' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-2 text-sm font-medium transition-colors">Courses</button>
                    <button @click="tab = 'records'" :class="tab === 'records' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:text-gray-700'" class="px-3 py-2 text-sm font-medium transition-colors">Records</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Error Notification -->
        <div x-show="errorMessage" x-transition class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm flex justify-between items-center" x-cloak>
            <div class="flex items-center"><i class="fas fa-exclamation-circle text-red-500 mr-3"></i><span class="text-red-700 font-medium" x-text="errorMessage"></span></div>
            <button @click="errorMessage = ''" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
        </div>

        <!-- STUDENTS TAB -->
        <div x-show="tab === 'students'" x-transition>
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-1/3">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input x-model.debounce.500ms="searchQuery" @input="fetchStudents(1)" type="text" placeholder="Search students..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-center gap-2">
                    <select x-model="studentSort.by" @change="fetchStudents(1)" class="border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="id">ID</option><option value="name">Name</option><option value="age">Age</option><option value="created_at">Newest</option>
                    </select>
                    <button @click="toggleStudentSort" class="p-2 text-gray-500 bg-gray-100 rounded-md"><i class="fas" :class="studentSort.order === 'asc' ? 'fa-sort-amount-down-alt' : 'fa-sort-amount-up'"></i></button>
                    <button @click="showModal = 'student'" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 shadow-sm flex items-center"><i class="fas fa-plus mr-2"></i> Add Student</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <template x-for="student in students" :key="student.id">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow p-6 relative group">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-4">
                                <div class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-lg" x-text="student.name ? student.name.charAt(0) : '?'"></div>
                                <div><h3 class="text-lg font-semibold text-gray-900" x-text="student.name"></h3><p class="text-sm text-gray-500" x-text="student.email"></p></div>
                            </div>
                            <button @click="deleteStudent(student.id)" class="text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-50">
                            <div class="flex justify-between items-center mb-2"><span class="text-xs font-semibold text-gray-400 uppercase">Courses</span><span class="text-xs text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full" x-text="student.age ? `${student.age} yrs` : 'N/A'"></span></div>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="course in student.courses" :key="course.id">
                                    <span @click="navigateToRecord(student.id, course.id)" class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-50 text-blue-700 cursor-pointer hover:bg-blue-100 border border-blue-100"><span x-text="course.title"></span></span>
                                </template>
                                <span x-show="!student.courses.length" class="text-xs text-gray-400 italic">No enrollments</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            <div class="mt-8 flex justify-center gap-2" x-show="pagination.last_page > 1">
                <button @click="fetchStudents(pagination.current_page - 1)" :disabled="pagination.current_page <= 1" class="px-4 py-2 border rounded-md text-sm bg-white disabled:opacity-50">Prev</button>
                <span class="text-sm text-gray-600 pt-2">Page <span x-text="pagination.current_page"></span></span>
                <button @click="fetchStudents(pagination.current_page + 1)" :disabled="pagination.current_page >= pagination.last_page" class="px-4 py-2 border rounded-md text-sm bg-white disabled:opacity-50">Next</button>
            </div>
        </div>

        <!-- COURSES TAB -->
        <div x-show="tab === 'courses'" x-cloak x-transition>
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6 flex gap-4 items-end">
                <div class="flex-grow"><label class="block text-sm font-medium text-gray-700 mb-1">Title</label><input x-model="newCourse.title" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <div class="w-32"><label class="block text-sm font-medium text-gray-700 mb-1">Credits</label><input x-model.number="newCourse.credits" type="number" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                <button @click="createCourse" class="bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 shadow-sm">Create</button>
            </div>
            <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Credits</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="course in courses" :key="course.id">
                            <tr class="hover:bg-gray-50"><td class="px-6 py-4 text-sm font-medium text-gray-900" x-text="course.title"></td><td class="px-6 py-4"><span class="px-2 text-xs font-semibold rounded-full bg-green-100 text-green-800" x-text="course.credits"></span></td><td class="px-6 py-4 text-right text-sm font-medium"><button @click="deleteCourse(course.id)" class="text-red-600 hover:text-red-900">Delete</button></td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RECORDS TAB -->
        <div x-show="tab === 'records'" x-cloak x-transition>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-sm h-fit">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b border-gray-100">Selection</h3>
                    <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-1">Student</label><select x-model="selectedStudentId" @change="loadStudentEnrollments" class="block w-full border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"><option value="">Choose...</option><template x-for="s in allStudents" :key="s.id"><option :value="s.id" x-text="s.name"></option></template></select></div>
                    <div x-show="selectedStudentId" x-transition>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enrolled Courses</label>
                        <div class="space-y-2 mb-6">
                            <template x-for="c in availableCourses" :key="c.id">
                                <button @click="selectCourseForRecord(c.id)" :class="selectedCourseId === c.id ? 'bg-indigo-50 border-indigo-500 text-indigo-700 ring-1 ring-indigo-500' : 'bg-white border-gray-200 text-gray-700 hover:border-indigo-300'" class="w-full text-left px-4 py-3 border rounded-md transition-all flex justify-between items-center group"><span class="font-medium" x-text="c.title"></span><i class="fas fa-chevron-right text-gray-400 group-hover:text-indigo-500" :class="selectedCourseId === c.id ? 'text-indigo-600' : ''"></i></button>
                            </template>
                            <div x-show="availableCourses.length === 0" class="text-sm text-gray-500 italic p-2">Not enrolled in any courses.</div>
                        </div>
                        <div class="pt-4 border-t border-gray-100"><label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Enroll New</label><div class="flex gap-2"><select x-model="courseToEnrollId" class="block w-full text-sm border-gray-300 focus:ring-indigo-500 rounded-md"><option value="">Select...</option><template x-for="c in courses" :key="c.id"><option :value="c.id" x-text="c.title"></option></template></select><button @click="enroll" :disabled="!courseToEnrollId" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:opacity-50 text-sm font-medium">Add</button></div></div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm relative overflow-hidden" x-show="selectedCourseId" x-transition>
                    <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><i class="fas fa-file-alt text-9xl"></i></div>
                    <h3 class="text-lg font-bold text-gray-900 mb-6 pb-2 border-b border-gray-100">Academic Record</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Grade</label><div class="relative rounded-md shadow-sm"><input x-model.number="currentRecord.grade" type="number" min="0" max="100" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full text-3xl font-bold border-gray-300 rounded-md p-4 text-center text-indigo-600" placeholder="0"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">/ 100</span></div></div><input type="range" min="0" max="100" x-model.number="currentRecord.grade" class="w-full mt-4 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Attendance</label><div class="grid grid-cols-2 gap-3 mb-4"><button @click="markAttendance('A')" class="flex flex-col items-center justify-center p-3 border border-transparent text-sm font-medium rounded-md text-emerald-700 bg-emerald-100 hover:bg-emerald-200"><i class="fas fa-check-circle text-xl mb-1"></i>Present (A)</button><button @click="markAttendance('X')" class="flex flex-col items-center justify-center p-3 border border-transparent text-sm font-medium rounded-md text-rose-700 bg-rose-100 hover:bg-rose-200"><i class="fas fa-times-circle text-xl mb-1"></i>Absent (X)</button></div></div>
                    </div>
                    <div class="mb-8"><div class="flex justify-between items-end mb-2"><label class="block text-sm font-medium text-gray-700">Log</label><button @click="currentRecord.attendance_record = ''" class="text-xs text-gray-400 hover:text-red-500">Clear</button></div><div class="bg-gray-900 rounded-md p-4 overflow-x-auto"><div class="font-mono text-lg tracking-[0.2em] whitespace-nowrap min-h-[1.75rem]"><template x-for="(char, index) in (currentRecord.attendance_record || '').split('')" :key="index"><span :class="char === 'A' ? 'text-emerald-400' : 'text-rose-400'" x-text="char"></span></template><span x-show="!currentRecord.attendance_record" class="text-gray-600 text-sm tracking-normal italic">No attendance recorded yet.</span></div></div></div>
                    <div class="flex justify-end pt-4 border-t border-gray-100"><button @click="saveRecord" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"><i class="fas fa-save mr-2"></i> Save Record</button></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Modal -->
    <div x-show="showModal" class="fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-cloak>
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showModal" x-transition.opacity class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = null"></div>
            <div x-show="showModal" x-transition class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add New Student</h3>
                    <div class="space-y-4"><input x-model="newStudent.name" type="text" placeholder="Name" class="w-full border-gray-300 rounded-md shadow-sm p-2 border"><input x-model="newStudent.email" type="email" placeholder="Email" class="w-full border-gray-300 rounded-md shadow-sm p-2 border"><input x-model.number="newStudent.age" type="number" placeholder="Age" class="w-full border-gray-300 rounded-md shadow-sm p-2 border"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button @click="createStudent" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button><button @click="showModal = null" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                tab: 'students', showModal: null, errorMessage: '', baseUrl: 'http://127.0.0.1:8000/api',
                students: [], courses: [], allStudents: [], availableCourses: [], pagination: {},
                searchQuery: '', studentSort: { by: 'id', order: 'desc' },
                newStudent: { name: '', email: '', age: '' }, newCourse: { title: '', credits: '' },
                selectedStudentId: '', selectedCourseId: '', courseToEnrollId: '', currentRecord: { grade: 0, attendance_record: '' },

                init() {
                    if (window.location.protocol === 'file:') return this.errorMessage = "CRITICAL: Open via localhost";
                    this.fetchStudents(); this.fetchCourses(); this.fetchAllStudents();
                },
                async req(url, method = 'GET', body = null) {
                    try {
                        const opts = { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' } };
                        if (body) opts.body = JSON.stringify(body);
                        const res = await fetch(url, opts);
                        if (!res.ok) throw new Error((await res.json()).message || 'Request failed');
                        return res.status === 204 ? true : await res.json();
                    } catch (e) { this.errorMessage = e.message; setTimeout(() => this.errorMessage = '', 5000); return null; }
                },
                async fetchStudents(page = 1) {
                    const data = await this.req(`${this.baseUrl}/students?page=${page}&search=${this.searchQuery}&sort_by=${this.studentSort.by}&sort_order=${this.studentSort.order}`);
                    if (data) { this.students = data.data; this.pagination = data; }
                },
                toggleStudentSort() { this.studentSort.order = this.studentSort.order === 'asc' ? 'desc' : 'asc'; this.fetchStudents(1); },
                async createStudent() { if(await this.req(`${this.baseUrl}/students`, 'POST', this.newStudent)) { this.showModal = null; this.newStudent = {name:'',email:'',age:''}; this.fetchStudents(); } },
                async deleteStudent(id) { if(confirm('Delete?')) { await this.req(`${this.baseUrl}/students/${id}`, 'DELETE'); this.fetchStudents(this.pagination.current_page); } },
                async fetchAllStudents() { const data = await this.req(`${this.baseUrl}/students?per_page=100`); if(data) this.allStudents = data.data; },
                async fetchCourses() { const data = await this.req(`${this.baseUrl}/courses?per_page=100`); if(data) this.courses = data.data; },
                async createCourse() { if(await this.req(`${this.baseUrl}/courses`, 'POST', this.newCourse)) { this.newCourse = {title:'', credits:''}; this.fetchCourses(); } },
                async deleteCourse(id) { if(confirm('Delete?')) { await this.req(`${this.baseUrl}/courses/${id}`, 'DELETE'); this.fetchCourses(); } },
                
                async loadStudentEnrollments() {
                    if(!this.selectedStudentId) return;
                    this.availableCourses = await this.req(`${this.baseUrl}/enrollments/student/${this.selectedStudentId}`) || [];
                    this.selectedCourseId = null;
                },
                async enroll() {
                    if(await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${this.courseToEnrollId}`, 'POST')) {
                        await this.loadStudentEnrollments(); 
                        this.courseToEnrollId = '';
                    }
                },
                async selectCourseForRecord(cid) {
                    this.selectedCourseId = cid;
                    const data = await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${cid}`);
                    this.currentRecord = data ? { grade: data.grade||0, attendance_record: data.attendance_record||'' } : { grade:0, attendance_record:'' };
                },
                markAttendance(type) { this.currentRecord.attendance_record += type; },
                async saveRecord() { if(await this.req(`${this.baseUrl}/enrollments/${this.selectedStudentId}/${this.selectedCourseId}`, 'PUT', this.currentRecord)) alert('Saved!'); },
                navigateToRecord(sid, cid) { this.tab = 'records'; this.selectedStudentId = sid; this.loadStudentEnrollments().then(() => this.selectCourseForRecord(cid)); }
            }))
        })
    </script>
</body>
</html>